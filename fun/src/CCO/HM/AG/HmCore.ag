module {CCO.HM.AG.HmCore}{}{}
{
import CCO.HM.AG.BaseHelpers
import CCO.HM.AG.ANormal
import CCO.HM.Context
import qualified CCO.Core.AG.Base as C
}

include "ANormal.ag"

attr ATm AExp AVal
  inh context :: {Context}

attr AVal
  syn code :: {C.SExp}

attr ATm AExp
  syn code :: {C.Exp}

attr ATm
  syn bindings use {++} {[]} :: {[C.Bind]}

sem AVal
  | ANat lhs.code     = C.Int @i
  | AVar lhs.code     = C.Var $ resolve @x @lhs.context

sem AExp
  | AVal lhs.code     = C.SExp @v.code
  | AApp lhs.code     = C.App @e.code [@v.code]
  | ALam loc.context  = push @x $ pushFrame @lhs.context
         lhs.code     = C.Lam [resolve @x @loc.context] @t.code
         lhs.bindings = []

sem ATm
  | ALet lhs.code     = @t.code
         t  .context  = @loc.context
         loc.context  = push @x @lhs.context
         lhs.bindings = [C.Bind (resolve @x @loc.context) @e.code] ++ @t.bindings

